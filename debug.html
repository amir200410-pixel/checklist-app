<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דיבאג - מנהל המשימות</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 20px;
            direction: rtl;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .debug-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .debug-data {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐛 דף דיבאג</h1>
        
        <div class="debug-section">
            <h3>🌐 מידע שרת</h3>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <strong>כתובת שרת רשת:</strong><br>
                <code style="font-size: 1.1rem; color: #1976d2;">http://192.168.1.8:3000</code><br>
                <small style="color: #666;">השתמש בכתובת זו כדי לגשת למערכת מטלפונים אחרים</small>
            </div>
            <h3>📊 מצב המערכת</h3>
            <div id="systemStatus"></div>
            <button class="btn" onclick="refreshStatus()">🔄 רענן</button>
        </div>
        
        <div class="debug-section">
            <h3>👥 משתמשים במערכת</h3>
            <div id="usersData"></div>
            <button class="btn" onclick="createTestUsers()">➕ צור משתמשי בדיקה</button>
            <button class="btn danger" onclick="clearUsers()">🗑️ נקה משתמשים</button>
        </div>
        
        <div class="debug-section">
            <h3>📝 משימות</h3>
            <div id="tasksData"></div>
            <button class="btn" onclick="createTestTasks()">➕ צור משימות בדיקה</button>
            <button class="btn danger" onclick="clearTasks()">🗑️ נקה משימות</button>
        </div>
        
        <div class="debug-section">
            <h3>🔄 בקשות העברה</h3>
            <div id="transferRequestsData"></div>
            <button class="btn danger" onclick="clearTransferRequests()">🗑️ נקה בקשות העברה</button>
        </div>
        
        <div class="debug-section">
            <h3>💾 Session Storage</h3>
            <div id="sessionData"></div>
            <button class="btn danger" onclick="clearSession()">🗑️ נקה Session</button>
        </div>

        <div class="debug-section">
            <h3>🔄 סנכרון נתונים</h3>
            <div id="syncData"></div>
            <button class="btn" onclick="manualSync()">🔄 סנכרון ידני</button>
            <button class="btn" onclick="refreshSyncStatus()">📊 רענן סטטוס</button>
        </div>

        <div class="debug-section">
            <h3>🌐 חיבור רשת</h3>
            <div id="networkData"></div>
            <button class="btn" onclick="refreshNetworkStatus()">📡 רענן חיבור</button>
        </div>

        <div class="debug-section">
            <h3>🖥️ סטטוס שרת</h3>
            <div id="serverData"></div>
            <button class="btn" onclick="refreshServerStatus()">🔄 רענן סטטוס שרת</button>
            <button class="btn" onclick="forceSync()">⚡ סנכרון כפוי</button>
        </div>
        
        <div class="debug-section">
            <h3>🔧 פעולות מהירות</h3>
            <button class="btn" onclick="setupCompleteTest()">🎯 הגדר מערכת מלאה לבדיקה</button>
            <button class="btn danger" onclick="clearAllData()">💥 נקה הכל</button>
            <a href="welcome.html" class="btn">🏠 חזור לדף הבית</a>
        </div>
    </div>

    <script>
        function refreshStatus() {
            displaySystemStatus();
            displayUsers();
            displayTasks();
            displayTransferRequests();
            displaySessionData();
        }
        
        function displaySystemStatus() {
            const users = JSON.parse(localStorage.getItem('appUsers') || '[]');
            const tasks = JSON.parse(localStorage.getItem('manager-tasks') || '[]');
            const transferRequests = JSON.parse(localStorage.getItem('transferRequests') || '[]');
            
            const statusDiv = document.getElementById('systemStatus');
            let html = '';
            
            // בדיקת משתמשים
            if (users.length === 0) {
                html += '<div class="status error">❌ אין משתמשים במערכת</div>';
            } else {
                const managers = users.filter(u => u.role === 'manager');
                const workers = users.filter(u => u.role === 'worker');
                html += `<div class="status success">✅ ${users.length} משתמשים במערכת (${managers.length} מנהלים, ${workers.length} עובדים)</div>`;
            }
            
            // בדיקת משימות
            if (tasks.length === 0) {
                html += '<div class="status warning">⚠️ אין משימות במערכת</div>';
            } else {
                const pending = tasks.filter(t => t.status === 'pending').length;
                const completed = tasks.filter(t => t.status === 'completed').length;
                html += `<div class="status success">✅ ${tasks.length} משימות במערכת (${pending} ממתינות, ${completed} הושלמו)</div>`;
            }
            
            // בדיקת בקשות העברה
            if (transferRequests.length === 0) {
                html += '<div class="status warning">⚠️ אין בקשות העברה</div>';
            } else {
                const pending = transferRequests.filter(r => r.status === 'pending').length;
                html += `<div class="status success">✅ ${transferRequests.length} בקשות העברה (${pending} ממתינות)</div>`;
            }
            
            statusDiv.innerHTML = html;
        }
        
        function displayUsers() {
            const users = JSON.parse(localStorage.getItem('appUsers') || '[]');
            const usersDiv = document.getElementById('usersData');
            
            if (users.length === 0) {
                usersDiv.innerHTML = '<div class="status error">אין משתמשים</div>';
                return;
            }
            
            let html = '<div class="debug-data">';
            users.forEach(user => {
                html += `שם משתמש: ${user.username}\n`;
                html += `סיסמה: ${user.password}\n`;
                html += `תפקיד: ${user.role}\n`;
                html += `שם מלא: ${user.fullName || 'לא מוגדר'}\n`;
                html += `אימייל: ${user.email || 'לא מוגדר'}\n`;
                html += `נוצר: ${user.createdAt || 'לא מוגדר'}\n`;
                html += '---\n';
            });
            html += '</div>';
            usersDiv.innerHTML = html;
        }
        
        function displayTasks() {
            const tasks = JSON.parse(localStorage.getItem('manager-tasks') || '[]');
            const tasksDiv = document.getElementById('tasksData');
            
            if (tasks.length === 0) {
                tasksDiv.innerHTML = '<div class="status warning">אין משימות</div>';
                return;
            }
            
            let html = '<div class="debug-data">';
            tasks.forEach(task => {
                html += `מזהה: ${task.id}\n`;
                html += `כותרת: ${task.title}\n`;
                html += `עובד אחראי: ${task.assignedWorker}\n`;
                html += `סטטוס: ${task.status}\n`;
                html += `עדיפות: ${task.priority}\n`;
                html += `תאריך יעד: ${task.deadline}\n`;
                html += '---\n';
            });
            html += '</div>';
            tasksDiv.innerHTML = html;
        }
        
        function displayTransferRequests() {
            const requests = JSON.parse(localStorage.getItem('transferRequests') || '[]');
            const requestsDiv = document.getElementById('transferRequestsData');
            
            if (requests.length === 0) {
                requestsDiv.innerHTML = '<div class="status warning">אין בקשות העברה</div>';
                return;
            }
            
            let html = '<div class="debug-data">';
            requests.forEach(request => {
                html += `מזהה: ${request.id}\n`;
                html += `משימה: ${request.taskTitle}\n`;
                html += `מעובד: ${request.fromWorker}\n`;
                html += `לעובד: ${request.toWorker}\n`;
                html += `סטטוס: ${request.status}\n`;
                html += `נוצר: ${request.createdAt}\n`;
                html += '---\n';
            });
            html += '</div>';
            requestsDiv.innerHTML = html;
        }
        
        function displaySessionData() {
            const sessionDiv = document.getElementById('sessionData');
            let html = '<div class="debug-data">';
            
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                const value = sessionStorage.getItem(key);
                html += `${key}: ${value}\n`;
            }
            
            if (sessionStorage.length === 0) {
                html += 'אין נתונים ב-Session Storage';
            }
            
            html += '</div>';
            sessionDiv.innerHTML = html;
        }
        
        function createTestUsers() {
            const testUsers = [
                {
                    username: 'admin',
                    password: '1234',
                    fullName: 'מנהל ראשי',
                    email: 'admin@example.com',
                    role: 'manager',
                    createdAt: new Date().toISOString()
                },
                {
                    username: 'worker1',
                    password: '1234',
                    fullName: 'עובד ראשון',
                    email: 'worker1@example.com',
                    role: 'worker',
                    createdAt: new Date().toISOString()
                },
                {
                    username: 'worker2',
                    password: '1234',
                    fullName: 'עובד שני',
                    email: 'worker2@example.com',
                    role: 'worker',
                    createdAt: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('appUsers', JSON.stringify(testUsers));
            alert('✅ נוצרו משתמשי בדיקה בהצלחה!');
            refreshStatus();
        }
        
        function createTestTasks() {
            const testTasks = [
                {
                    id: Date.now(),
                    title: 'משימת בדיקה ראשונה',
                    description: 'תיאור משימת בדיקה',
                    assignedWorker: 'worker1',
                    deadline: new Date(Date.now() + 86400000).toISOString().slice(0, 16),
                    priority: 'medium',
                    status: 'pending',
                    createdAt: new Date().toISOString()
                },
                {
                    id: Date.now() + 1,
                    title: 'משימת בדיקה שנייה',
                    description: 'תיאור משימת בדיקה נוספת',
                    assignedWorker: 'worker2',
                    deadline: new Date(Date.now() + 172800000).toISOString().slice(0, 16),
                    priority: 'high',
                    status: 'pending',
                    createdAt: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('manager-tasks', JSON.stringify(testTasks));
            alert('✅ נוצרו משימות בדיקה בהצלחה!');
            refreshStatus();
        }
        
        function clearUsers() {
            if (confirm('האם למחוק את כל המשתמשים?')) {
                localStorage.removeItem('appUsers');
                alert('🗑️ המשתמשים נמחקו');
                refreshStatus();
            }
        }
        
        function clearTasks() {
            if (confirm('האם למחוק את כל המשימות?')) {
                localStorage.removeItem('manager-tasks');
                alert('🗑️ המשימות נמחקו');
                refreshStatus();
            }
        }
        
        function clearTransferRequests() {
            if (confirm('האם למחוק את כל בקשות ההעברה?')) {
                localStorage.removeItem('transferRequests');
                alert('🗑️ בקשות ההעברה נמחקו');
                refreshStatus();
            }
        }
        
        function clearSession() {
            if (confirm('האם למחוק את ה-Session?')) {
                sessionStorage.clear();
                alert('🗑️ ה-Session נמחק');
                refreshStatus();
            }
        }
        
        function setupCompleteTest() {
            createTestUsers();
            createTestTasks();
            alert('🎯 המערכת מוכנה לבדיקה!\n\nפרטי התחברות:\nמנהל: admin / 1234\nעובד: worker1 / 1234');
        }
        
        function clearAllData() {
            if (confirm('האם למחוק את כל הנתונים במערכת?')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('💥 כל הנתונים נמחקו');
                refreshStatus();
            }
        }
        
        function displaySyncData() {
            const syncDiv = document.getElementById('syncData');
            if (typeof window.checkSyncStatus === 'function') {
                const status = window.checkSyncStatus();
                let html = '<div class="debug-data">';
                html += `סנכרון פעיל: ${status.isRunning ? '✅' : '❌'}\n`;
                html += `זמן עדכון אחרון: ${status.timestamp}\n`;
                html += 'נתונים אחרונים:\n';
                Object.keys(status.lastSync).forEach(key => {
                    const data = status.lastSync[key];
                    html += `  ${key}: ${Array.isArray(data) ? data.length : 'N/A'} פריטים\n`;
                });
                html += '</div>';
                syncDiv.innerHTML = html;
            } else {
                syncDiv.innerHTML = '<div class="status error">מנהל הסנכרון לא זמין</div>';
            }
        }

        function displayNetworkData() {
            const networkDiv = document.getElementById('networkData');
            if (typeof window.checkNetwork === 'function') {
                const status = window.checkNetwork();
                let html = '<div class="debug-data">';
                html += `מחובר לרשת: ${status.online ? '✅' : '❌'}\n`;
                html += `דפדפן: ${status.userAgent.split(' ')[0]}\n`;
                html += `זמן בדיקה: ${status.timestamp}\n`;
                html += '</div>';
                networkDiv.innerHTML = html;
            } else {
                networkDiv.innerHTML = '<div class="status error">פונקציית בדיקת רשת לא זמינה</div>';
            }
        }

        function refreshSyncStatus() {
            displaySyncData();
        }

        function displayServerData() {
            const serverDiv = document.getElementById('serverData');
            if (typeof window.getServerStatus === 'function') {
                window.getServerStatus().then(status => {
                    if (status) {
                        let html = '<div class="debug-data">';
                        html += `סטטוס שרת: ${status.server}\n`;
                        html += `משתמשים: ${status.users}\n`;
                        html += `משימות: ${status.tasks}\n`;
                        html += `בקשות העברה: ${status.transfers}\n`;
                        html += `זמן עדכון: ${new Date(status.timestamp * 1000).toLocaleString('he-IL')}\n`;
                        html += '</div>';
                        serverDiv.innerHTML = html;
                    } else {
                        serverDiv.innerHTML = '<div class="status error">לא ניתן להתחבר לשרת</div>';
                    }
                });
            } else {
                serverDiv.innerHTML = '<div class="status error">פונקציית סטטוס שרת לא זמינה</div>';
            }
        }

        async function forceSync() {
            if (typeof window.forceSync === 'function') {
                const result = await window.forceSync();
                alert(result);
                refreshStatus();
            } else {
                alert('פונקציית סנכרון לא זמינה');
            }
        }

        function refreshServerStatus() {
            displayServerData();
        }

        function refreshNetworkStatus() {
            displayNetworkData();
        }

        function refreshStatus() {
            displaySystemStatus();
            displayUsers();
            displayTasks();
            displayTransferRequests();
            displaySessionData();
            displaySyncData();
            displayNetworkData();
            displayServerData();
        }

        // טעינת הנתונים בטעינת הדף
        document.addEventListener('DOMContentLoaded', refreshStatus);
    </script>
</body>
</html> 